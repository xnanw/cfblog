/**
 * Minified by jsDelivr using Terser v5.3.0.
 * Original file: /gh/seatwork/pagetalk@1.0.3/pagetalk.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
class PageTalk{constructor(e){this.importScripts(["https://cdn.jsdelivr.net/npm/blueimp-md5@2.18.0/js/md5.min.js","https://cdn.jsdelivr.net/npm/marked@0.6.3/marked.min.js"]).then(()=>{marked.setOptions({sanitize:!0}),this.className=e.className||"PageTalk_Comment",this.lcs=new LeanCloudStorage(e),this.listComments()}),this.emailReg=/^[a-zA-Z0-9_\-\.]+\@[a-zA-Z0-9_\-\.]+\.([a-zA-Z]{2,8})$/,this.urlReg=/^https?:\/\/[a-zA-Z0-9\-\.]+\.[a-zA-Z0-9\-\.]+(\:\d+)?[\w\-\/\.@?=%&+#]*$/,this.avatar="https://sdn.geekzu.org/avatar/",this.onMessage=e.onMessage||function(){},this.createHeader(e.container)}createHeader(e){(e=document.querySelector(e)).innerHTML="";const t=this.loadLastUser(),s=this._(`<div class="pgtk-container"><div class="pgtk-section"><div class="pgtk-avatar"><img src="${t.avatar}"/></div><div class="pgtk-form"><div class="pgtk-form-inputs"><input type="text" id="pgtk-nickname" value="${t.nickname}" maxlength="20" placeholder="昵称 (必填)"><input type="text" id="pgtk-email" value="${t.email}" maxlength="50" placeholder="邮箱 (可选, 用于显示全球头像)"><input type="text" id="pgtk-website" value="${t.website}" maxlength="50" placeholder="网站 (可选)"></div><div class="pgtk-textarea pgtk-markdown" placeholder="不说点什么就说不过去..." contenteditable="plaintext-only"></div><div class="pgtk-controls"><div class="pgtk-badge"><a target="_blank" href="https://guides.github.com/features/mastering-markdown/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1280 1024" height="18"><path d="M1188 906H92c-51 0-92-42-92-92V210c0-50 41-92 92-92h1096c51 0 92 42 92 92v604c0 50-41 92-92 92zM308 721V481l123 154 123-154v240h123V303H554L431 457 308 303H185v418h123zm824-209h-123V303H886v209H763l185 215 184-215z"/></svg></a><a target="_blank" href="https://seatwork.github.io/pagetalk"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 82 13" height="10"><path d="M1 1.3l.1-.3h4.1q5 0 5 4 0 2-1.4 3-1.3 1.1-3.7 1.1H3.8v2.6l-.1.3-.3.1H1l-.1-.4zm4 5.2q1.1 0 1.7-.3.5-.4.5-1.2 0-.8-.5-1.2-.5-.3-1.6-.3H3.8V6.5H4zM13.8 1.5q.2-.5.4-.6l.4-.2.4.2.5.6 5 10v.4q0 .2-.3.2h-2.5l-.2-.4-.6-1.3-.2-.2h-4.3l-.1.2-.6 1.3q-.1.3-.3.3l-.4.1H9q-.3 0-.3-.2v-.3zM15.5 8l.1-.1v-.2l-1-2.2-1 2.2-.1.2h.2zM28 7v-.4l.4-.1h2l.3.1V11l-.3.2q-1 .6-2.2.9-1 .2-2.2.2-1.7 0-3-.7-1.4-.7-2.2-2-.8-1.3-.8-3t.8-3q.8-1.4 2.2-2.2Q24.4.7 26 .7q1.2 0 2.3.3 1 .4 1.9 1 .3.1.3.3l-.1.4-.9 1.2-.1.2H29q-1.4-.8-2.9-.8-1 0-1.7.4t-1 1.2q-.5.7-.5 1.6 0 1 .4 1.7.4.8 1.1 1.2.7.4 1.6.4 1 0 1.7-.3l.2-.1v-.2zM32 1.3l.1-.3H39.2q.4 0 .4.3v2.1H35l-.2.1v1.7H38.7l.3.1v2.4H35l-.2.1v1.7h4.3q.2 0 .3.2l.1.3v1.7q0 .4-.4.4H32.1v-.4zM45.5 3.7v-.2H42.6l-.3-.1V1.3 1H51.4v2.4h-2.9l-.2.1v8.2l-.1.3-.3.1h-2.3l-.1-.4zM54.9 1.5q.2-.5.4-.6l.4-.2.4.2.5.6 5 10v.4q0 .2-.3.2h-2.5l-.2-.4-.7-1.3v-.2h-4.3-.1l-.1.2-.6 1.3q-.1.3-.3.3l-.4.1h-2q-.3 0-.3-.2v-.3zM56.6 8l.1-.1v-.2l-1-2.2-1 2.2-.1.2h.1zM62.5 1.3V1h2.6q.2.1.2.3v8.2h4.3q.2 0 .3.2l.1.3v2l-.4.1h-7l-.1-.4zM70.9 1.3V1H73.7V12l-.4.1H71l-.1-.4zM74 6.8l-.2-.3.2-.4 3.3-4.8.4-.3H80.5l.3.1v.3l-3.8 5 3.9 5.3.1.2-.1.2H77.8l-.3-.4z"/></svg></a></div><button class="pgtk-submit">评论</button><button class="pgtk-preview">预览</button></div></div></div><div class="pgtk-message"></div><div id="pgtk-comment-list"></div></div>`);s.querySelector(".pgtk-submit").addEventListener("click",e=>this.addComment(e)),s.querySelector(".pgtk-preview").addEventListener("click",e=>this.switchPreview(e)),e.appendChild(s),this.element={nickname:s.querySelector("#pgtk-nickname"),email:s.querySelector("#pgtk-email"),website:s.querySelector("#pgtk-website"),textarea:s.querySelector(".pgtk-textarea"),message:s.querySelector(".pgtk-message"),submit:s.querySelector(".pgtk-submit"),preview:s.querySelector(".pgtk-preview"),comments:s.querySelector("#pgtk-comment-list")}}async listComments(){this.setMessage("正在加载...");const e=await this.lcs.queryObjects(`select * from ${this.className} where pageId = '${location.pathname}' order by createdAt desc`);if(e.error)return this.setMessage(e.error,!0);this.setMessage(`共 ${e.results.length} 条评论`),e.results.forEach(e=>{const t=this.markComment(e),s=this.createSection(t);this.element.comments.appendChild(s)})}async addComment(e){const t=this.element.textarea,s={nickname:this.element.nickname.value.trim(),email:this.element.email.value.trim(),website:this.element.website.value.trim(),content:(t.orginalContent||t.textContent).trim(),pageId:location.pathname};let a=this.verifyFormData(s);if(!0!==a)return this.setMessage(a,!0);if(this.element.submit.disabled=!0,a=await this.lcs.insertObject(this.className,s),this.element.submit.disabled=!1,a.error)return this.setMessage(a.error,!0);s.objectId=a.objectId,s.createdAt=a.createdAt;const i=this.markComment(s),n=this.createSection(i),r=this.element.comments.children;0===r.length?this.element.comments.appendChild(n):this.element.comments.insertBefore(n,r[0]),this.setMessage(`共 ${r.length} 条评论`),this.clearPreview(),this.saveLastUser(i),this.onMessage(i)}createSection(e){const t=this._(`<div class="pgtk-section"><div class="pgtk-avatar"><img src="${e.avatar}"/><div class="pgtk-triangle"></div></div><div class="pgtk-comment"><div class="pgtk-profile"><div><a target="_blank" href="${e.website}">${e.nickname}</a> 发表于 ${e.createdAt}</div><svg id="pgtk-reply-icon" viewBox="0 0 1332 1024" width="14"><path d="M529.066665 273.066666 529.066665 0 51.2 477.866666 529.066665 955.733335 529.066665 675.84C870.4 675.84 1109.333335 785.066665 1280 1024 1211.733335 682.666665 1006.933335 341.333334 529.066665 273.066666"></path></svg></div><div class="pgtk-markdown">${e.htmlContent}</div></div></div>`);return t.querySelector("#pgtk-reply-icon").addEventListener("click",t=>this.reply(e)),t}reply(e){const t=e.content.split("\n");t.forEach((e,s)=>t[s]="> "+e),t.unshift("> @"+e.nickname),t.push("\n\n"),this.element.textarea.textContent=t.join("\n"),this.moveCursorToEnd(this.element.textarea)}switchPreview(){const e=this.element.textarea;e.isContentEditable?(e.setAttribute("contenteditable",!1),e.orginalContent=e.textContent,e.innerHTML=marked(e.textContent),this.element.preview.innerHTML="编辑"):(e.setAttribute("contenteditable","plaintext-only"),e.textContent=e.orginalContent,e.orginalContent="",this.element.preview.innerHTML="预览",this.moveCursorToEnd(e))}clearPreview(){const e=this.element.textarea;e.textContent=e.orginalContent="",e.isContentEditable||(e.setAttribute("contenteditable","plaintext-only"),this.element.preview.innerHTML="预览")}markComment(e){return e.avatar=this.avatar+md5(e.email),e.createdAt=this.formatDate(e.createdAt),e.htmlContent=marked(e.content),e}verifyFormData(e){return e.nickname?e.nickname.match(/[\<\>]+/)?"昵称不能包含尖括号":e.email&&!e.email.match(this.emailReg)?"邮箱格式有误":e.website&&!e.website.match(this.urlReg)?"网站格式有误":e.content?!(e.content.length>2e3)||"评论内容超过 2000 字限制":"评论内容不能为空":"昵称不能为空"}setMessage(e,t=!1){this.element.message.innerHTML=e,t?this.element.message.classList.add("pgtk-error"):this.element.message.classList.remove("pgtk-error")}saveLastUser(e){localStorage.setItem("pagetalk-user",JSON.stringify({nickname:e.nickname,email:e.email,website:e.website,avatar:e.avatar}))}loadLastUser(){const e=JSON.parse(localStorage.getItem("pagetalk-user"))||{};return e.nickname=e.nickname||"",e.email=e.email||"",e.website=e.website||"",e.avatar=e.avatar||this.avatar,e}formatDate(e){return e=new Date(e).getTime()+288e5,new Date(e).toJSON().substr(0,10).replace(/\-/g,"/")}moveCursorToEnd(e){if(e.focus(),e.scrollTop=e.scrollHeight-e.clientHeight,window.getSelection){const t=window.getSelection();t.selectAllChildren(e),t.collapseToEnd()}else if(document.selection){const t=document.selection.createRange();t.moveToElementText(e),t.collapse(!1),t.select()}}importScripts(e){return new Promise((t,s)=>{const a=document.getElementsByTagName("head")[0],i=s=>{const n=document.createElement("script");n.setAttribute("type","text/javaScript"),n.setAttribute("src",e[s]),n.onload=n.onerror=()=>{++s===e.length?t():i(s)},a.appendChild(n)};i(0)})}_(e){if((e=e.replace("/\n/mg","").trim()).startsWith("<")){return document.createRange().createContextualFragment(e).firstChild}return document.querySelector(e)}}class LeanCloudStorage{constructor(e){this.api="https://6crg3osj.api.lncldglobal.com/1.1",this.defaultHeaders={"X-LC-Id":e.appId,"X-LC-Key":e.appKey,"Content-Type":"application/json"}}async queryObjects(e){return await this.tryFetch("/cloudQuery?cql="+e)}async getObjects(e){return await this.tryFetch("/classes/"+e)}async insertObject(e,t){return await this.tryFetch("/classes/"+e,{method:"POST",body:JSON.stringify(t)})}async deleteObject(e,t){return await this.tryFetch(`/classes/${e}/${t}`,{method:"DELETE"})}async tryFetch(e,t={}){t.headers=this.defaultHeaders;try{const s=await fetch(this.api+e,t);return await s.json()}catch(e){return{error:e.message}}}}
//# sourceMappingURL=/sm/64ee6e0e9acc85529d2ff312d2dd2fe179c2b5bd5d92c9fdf3fa61ab28e0e4d7.map